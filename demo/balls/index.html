<!doctype html>
<html>
  <head>
    <title>Ball Test</title>
    <style>
      html, body, canvas {
        height: 100%;
        width: 100%;
        margin: 0;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <script src="../../dist/ijmacd-game-engine.js"></script>
    <script>
      const canvas = document.getElementById('canvas');
      const game = new IGE.Game({
        canvas,
        width: canvas.offsetWidth,
        height: canvas.offsetHeight,
        autosize: true,
        score: 10,
        originCentric: true,
      });
      const falling = false;

      const cameraSystem = game.getDefaultCamera();
      // cameraSystem.setPosition(0, 0);
      const inputSystem = game.getDefaultInput();
      const renderSystem = game.getDefaultRenderer();
      const worldSystem = game.getDefaultWorld();
      const bounds = worldSystem.bounds;
      const bounds2 = bounds.map(x => x * 0.8);
      worldSystem.addComponent(new IGE.Components.BoundsAnimationComponent(bounds, bounds2, 5000, IGE.Easing.Linear));

      // ScoreRenderComponent
      game.root.addComponent((parent, delta) => {
        renderSystem.push(ctx => {
          ctx.fillStyle = "#000";
          ctx.font = "48px sans-serif";
          ctx.textAlign = "end";
          ctx.fillText(game.score, game.width - 25, game.height - 25);
        }, -1);
      });

      // TimeRenderComponent
      game.root.addComponent(new (class extends IGE.GameComponent {
        constructor () {
          super();
          this.time = 0;
          game.on("score", () => {
            this.time = 0;
          });
        }

        update (parent, delta) {
          this.time += delta;
          renderSystem.push(ctx => {
            ctx.fillStyle = "#000";
            ctx.font = "48px sans-serif";
            const t = this.time / 1000
            let s = Math.floor(t % 60);
            if(s < 10) s = "0" + s;
            let m = Math.floor(t / 60);
            ctx.fillText(`${m}:${s}`, 25, game.height - 25);
          }, -1);
        }
      }));

      // Click Marker
      const clickMarker = new IGE.GameObject();
      const smoothPosition = new IGE.Components.SmoothPositionComponent();
      smoothPosition.addComponent(new IGE.Components.MoveToClickComponent(game.getDefaultInput()));
      clickMarker.addComponent(smoothPosition);
      clickMarker.addComponent(new IGE.Debug.PositionRenderComponent(game.getDefaultRenderer()));
      game.addObject(clickMarker);

      let collisionSystem;
      if(falling) {
        collisionSystem = new IGE.Collision.BackgroundCollisionSystem();
        collisionSystem.addSurface([game.width * 0.25, game.height / 2 + 100, game.width / 2, game.height * 0.2, game.width * 0.75, game.height / 2 + 100]);
        collisionSystem.addSurface([0, game.height * 0.75, game.width * 0.25, game.height]);
        collisionSystem.addSurface([game.width, game.height * 0.75, game.width * 0.75, game.height]);

        game.root.addObjectAt(collisionSystem, 1);

        IGE.Components.BackgroundCollisionComponent.COEFFICIENT_FRICTION = 0.95;
        IGE.Components.BackgroundCollisionComponent.COEFFICIENT_RESTITUTION = 0.95;
      }

      function ballFactory (game, renderSystem) {
        const ball = new IGE.GameObject();
        setRandomPosition(ball, worldSystem);
        ball.setVelocity(Math.random()*0.1 - 0.05, Math.random()*0.1 - 0.05);
        const rx = Math.random() * 20 + 20;
        const ry = Math.random() * 20 + 20;
        const bounds  = [-rx, -ry, rx, ry];
        const bounds2 = [-ry, -rx, ry, rx];
        ball.setBounds(...bounds);
        const r = Math.random() * 255;
        const g = Math.random() * 255;
        const b = Math.random() * 255;
        const r1 = Math.random() * 255;
        const g1 = Math.random() * 255;
        const b1 = Math.random() * 255;
        const color = `rgba(${r|0},${g|0},${b|0},1)`;
        const color2 = `rgba(${r1|0},${g1|0},${b1|0},0.5)`;

        if (falling) {
          ball.addComponent(new IGE.Components.GravityComponent());
          ball.addComponent(new IGE.Components.TerminalVelocityComponent(0.5));
          ball.addComponent(new IGE.Components.MoveComponent());
          ball.addComponent(new IGE.Components.WorldWrapComponent(game.getDefaultWorld()));
          ball.addComponent(new IGE.Components.BackgroundCollisionComponent(collisionSystem));
          ball.addComponent(new IGE.Components.RectangleRenderComponent(renderSystem, color));
        } else {
          ball.addComponent(new IGE.Components.MoveComponent());
          ball.addComponent(new IGE.Components.RotationComponent(0.001));
          ball.addComponent(new IGE.Components.WorldBounceComponent(game.getDefaultWorld()));
          ball.addComponent(new IGE.Components.ColorAnimationComponent(color, color2, 3000));
          ball.addComponent(new IGE.Components.BoundsAnimationComponent(bounds, bounds2, 2000, IGE.Easing.Smooth));
          ball.addComponent(new IGE.Components.DotRenderComponent(renderSystem, color));
          // ball.addComponent(new IGE.Debug.DebugDrawBoundsComponent(renderSystem));

        }

        return ball;
      }

      function setRandomPosition(object, world) {
        const bounds = world.bounds;
        const minX = bounds[0];
        const minY = bounds[1];
        const width = bounds[2] - minX;
        const height = bounds[3] - minY;
        const x = Math.random() * width + minX;
        const y = Math.random() * height + minY;
        object.setPosition(x, y);
      }

      function addBall() {
        ballBag.addObject(ballFactory(game, renderSystem));
      }

      const ballBag = new IGE.GameObjectManager();

      for(let i = 0; i < game.score; i++) {
        addBall();
      }

      game.addObject(ballBag);

      game.start();

      inputSystem.on("keypress", key => {
        if(key == 38) { game.setScore(game.score + 1) }
        else if(key == 40) { game.setScore(game.score -1) }
      });

      inputSystem.on("click", () => { game.setScore(game.score - 1) });

      game.on("score", score => {
        if(ballBag.objects.length > score) {
          ballBag.objects.length = Math.max(score, 0);
        }
        else {
          while(ballBag.objects.length < score) {
            addBall();
          }
        }
      });
    </script>
  </body>
</html>
