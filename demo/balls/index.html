<!doctype html>
<html>
  <head>
    <title>Ball Test</title>
    <style>
      html, body, canvas {
        height: 100%;
        width: 100%;
        margin: 0;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <script src="../../dist/ijmacd-game-engine.js"></script>
    <script>
      const canvas = document.getElementById('canvas');
      const game = new IGE.Game({
        canvas,
        width: canvas.offsetWidth,
        height: canvas.offsetHeight,
        autosize: true,
        score: 10
      });
      const falling = false;

      const renderSystem = game.getDefaultRenderer();
      // renderSystem.context.globalCompositeOperation = "screen";
      let collisionSystem;

      // ScoreRenderComponent
      game.root.addComponent((parent, delta) => {
        renderSystem.push(ctx => {
          ctx.fillStyle = "#000";
          ctx.font = "48px sans-serif";
          ctx.textAlign = "end";
          ctx.fillText(game.score, game.width - 25, game.height - 25);
        }, -1);
      });

      if(falling) {
        collisionSystem = new IGE.Collision.BackgroundCollisionSystem();
        collisionSystem.addSurface([game.width * 0.25, game.height / 2 + 100, game.width / 2, game.height * 0.2, game.width * 0.75, game.height / 2 + 100]);
        collisionSystem.addSurface([0, game.height * 0.75, game.width * 0.25, game.height]);
        collisionSystem.addSurface([game.width, game.height * 0.75, game.width * 0.75, game.height]);

        IGE.Components.BackgroundCollisionComponent.COEFFICIENT_FRICTION = 0.95;
        IGE.Components.BackgroundCollisionComponent.COEFFICIENT_RESTITUTION = 0.95;
      }

      function ballFactory (game, renderSystem, color) {
        const ball = new IGE.GameObject();
        ball.setPosition(Math.random() * game.width, Math.random() * game.height);
        ball.setVelocity(Math.random()*0.1 - 0.05, Math.random()*0.1 - 0.05);
        const rx = Math.random() * 20 + 20;
        const ry = Math.random() * 20 + 20;
        ball.setBounds(-rx, -ry, rx, ry);

        if (falling) {
          ball.addComponent(new IGE.Components.GravityComponent());
          ball.addComponent(new IGE.Components.TerminalVelocityComponent(0.5));
          ball.addComponent(new IGE.Components.MoveComponent());
          ball.addComponent(new IGE.Components.WorldWrapComponent(game.getDefaultWorld()));
          ball.addComponent(new IGE.Components.BackgroundCollisionComponent(collisionSystem));
          ball.addComponent(new IGE.Components.RectangleRenderComponent(renderSystem, color));
        } else {
          ball.addComponent(new IGE.Components.MoveComponent());
          ball.addComponent(new IGE.Components.WorldBounceComponent(game.getDefaultWorld()));
          ball.addComponent(new IGE.Components.DotRenderComponent(renderSystem, color));
        }


        return ball;
      }

      const ballBag = new IGE.GameObjectManager();

      for(let i = 0; i < game.score; i++) {
        const r = Math.random() * 255;
        const g = Math.random() * 255;
        const b = Math.random() * 255;
        ballBag.addObject(ballFactory(game, renderSystem, `rgba(${r|0},${g|0},${b|0},0.5)`));
      }

      game.root.addObject(ballBag);

      if (falling) {
        game.root.addObject(collisionSystem);
      }

      game.root.addObject(renderSystem);

      game.start();

      document.addEventListener("keydown", e => {
        if(e.which == 38) { game.setScore(game.score + 1) }
        else if(e.which == 40) { game.setScore(game.score -1) }
      });

      document.addEventListener("click", e => game.setScore(game.score - 1));

      game.on("score", score => {
        if(ballBag.objects.length > score) {
          ballBag.objects.length = Math.max(score, 0);
        }
        else {
          while(ballBag.objects.length < score) {
            const r = Math.random() * 255;
            const g = Math.random() * 255;
            const b = Math.random() * 255;
            ballBag.addObject(ballFactory(game, renderSystem, `rgba(${r|0},${g|0},${b|0},0.5)`));
          }
        }
      });
    </script>
  </body>
</html>